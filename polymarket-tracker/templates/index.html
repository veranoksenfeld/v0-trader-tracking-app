<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polymarket Copy Trader</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #09090b; --bg-card: #131316; --bg-hover: #1a1a1f; --bg-input: #1e1e23;
            --border: #27272a; --border-hover: #3f3f46;
            --text: #fafafa; --text-sec: #a1a1aa; --text-dim: #71717a;
            --accent: #6366f1; --accent-hover: #4f46e5;
            --green: #22c55e; --green-dim: rgba(34,197,94,0.12);
            --red: #ef4444; --red-dim: rgba(239,68,68,0.12);
            --yellow: #eab308; --radius: 10px;
        }
        body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; line-height:1.5; }
        a { color:var(--accent); text-decoration:none; } a:hover { color:#818cf8; }

        .app { display:flex; flex-direction:column; min-height:100vh; }
        .topbar { display:flex; align-items:center; justify-content:space-between; padding:12px 24px; border-bottom:1px solid var(--border); background:var(--bg-card); position:sticky; top:0; z-index:50; }
        .topbar-left { display:flex; align-items:center; gap:20px; }
        .topbar-logo { font-size:18px; font-weight:700; background:linear-gradient(135deg,#6366f1,#8b5cf6); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .topbar-nav { display:flex; gap:4px; }
        .topbar-nav button { padding:7px 16px; background:transparent; border:none; color:var(--text-dim); font-size:13px; font-weight:500; border-radius:6px; cursor:pointer; transition:all .15s; }
        .topbar-nav button:hover { background:var(--bg-input); color:var(--text); }
        .topbar-nav button.active { background:var(--accent); color:#fff; }
        .topbar-right { display:flex; align-items:center; gap:10px; }
        .live-badge { display:flex; align-items:center; gap:6px; font-size:12px; color:var(--text-dim); padding:5px 10px; background:var(--bg-input); border-radius:6px; }
        .live-dot { width:7px; height:7px; border-radius:50%; background:var(--green); animation:pulse 2s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
        .balance-chip { display:flex; align-items:center; gap:8px; padding:5px 12px; background:var(--bg-input); border-radius:6px; font-size:13px; font-weight:600; color:var(--green); }
        .balance-chip .label { color:var(--text-dim); font-weight:400; }
        .engine-badge { display:flex; align-items:center; gap:6px; font-size:12px; padding:5px 10px; background:var(--bg-input); border-radius:6px; cursor:pointer; transition:all .15s; border:1px solid transparent; }
        .engine-badge:hover { border-color:var(--border-hover); }
        .engine-badge.on { color:var(--green); } .engine-badge.off { color:var(--text-dim); }

        .panels { display:flex; flex:1; overflow:hidden; }
        .panel-left { width:320px; min-width:320px; border-right:1px solid var(--border); display:flex; flex-direction:column; background:var(--bg-card); overflow-y:auto; }
        .panel-center { flex:1; overflow-y:auto; padding:24px; }

        .section-label { font-size:11px; font-weight:600; color:var(--text-dim); text-transform:uppercase; letter-spacing:.5px; padding:16px 16px 8px; }
        .add-form { display:flex; gap:8px; padding:12px 16px; }
        .add-form input { flex:1; padding:9px 12px; background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius); color:var(--text); font-size:13px; outline:none; }
        .add-form input:focus { border-color:var(--accent); }
        .add-form input::placeholder { color:var(--text-dim); }

        .btn { padding:9px 16px; background:var(--accent); color:#fff; border:none; border-radius:var(--radius); font-size:13px; font-weight:500; cursor:pointer; transition:background .15s; white-space:nowrap; }
        .btn:hover { background:var(--accent-hover); }
        .btn-sm { padding:5px 10px; font-size:12px; }
        .btn-ghost { background:transparent; color:var(--text-dim); padding:5px 8px; }
        .btn-ghost:hover { background:var(--bg-input); color:var(--text); }
        .btn-danger { background:var(--red); } .btn-danger:hover { background:#dc2626; }
        .btn-outline { background:transparent; border:1px solid var(--border); color:var(--text-sec); }
        .btn-outline:hover { border-color:var(--accent); color:var(--accent); background:transparent; }
        .btn-success { background:var(--green); } .btn-success:hover { background:#16a34a; }

        .trader-item { display:flex; align-items:center; gap:10px; padding:10px 16px; cursor:pointer; transition:background .1s; border-left:3px solid transparent; }
        .trader-item:hover { background:var(--bg-hover); }
        .trader-item.active { background:var(--bg-hover); border-left-color:var(--accent); }
        .trader-avatar { width:36px; height:36px; border-radius:50%; background:#27272a; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:13px; overflow:hidden; flex-shrink:0; }
        .trader-avatar img { width:100%; height:100%; object-fit:cover; }
        .trader-meta { flex:1; min-width:0; }
        .trader-meta .name { font-size:13px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:flex; align-items:center; gap:5px; }
        .trader-meta .addr { font-size:11px; color:var(--text-dim); font-family:monospace; }
        .badge { font-size:9px; font-weight:700; padding:2px 5px; border-radius:3px; text-transform:uppercase; }
        .badge-copy { background:var(--green-dim); color:var(--green); }
        .badge-verified { color:var(--accent); font-size:13px; }
        .trader-item .remove-btn { opacity:0; background:none; border:none; color:var(--text-dim); cursor:pointer; padding:4px; transition:all .15s; font-size:16px; }
        .trader-item:hover .remove-btn { opacity:1; }
        .trader-item .remove-btn:hover { color:var(--red); }

        .page { display:none; } .page.active { display:block; }

        .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px; }
        .card { background:var(--bg-card); border:1px solid var(--border); border-radius:12px; padding:20px; }
        .card h3 { font-size:13px; font-weight:500; color:var(--text-dim); margin-bottom:14px; text-transform:uppercase; letter-spacing:.3px; }

        .status-row { display:flex; align-items:center; justify-content:space-between; padding:10px 0; border-bottom:1px solid var(--border); }
        .status-row:last-child { border-bottom:none; }
        .status-row .label { font-size:13px; color:var(--text-sec); }
        .status-row .value { font-size:13px; font-weight:600; }
        .dot { width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px; }
        .dot.on { background:var(--green); } .dot.off { background:var(--red); } .dot.warn { background:var(--yellow); }

        .toggle-row { display:flex; align-items:center; justify-content:space-between; padding:14px; background:linear-gradient(135deg,#1e1b4b,#312e81); border-radius:var(--radius); margin-bottom:14px; }
        .toggle-row .info h4 { font-size:14px; font-weight:600; color:#fff; }
        .toggle-row .info p { font-size:12px; color:#a5b4fc; }
        .toggle { position:relative; width:48px; height:26px; background:#3f3f46; border-radius:13px; cursor:pointer; transition:background .2s; flex-shrink:0; }
        .toggle.active { background:var(--green); }
        .toggle::after { content:''; position:absolute; top:3px; left:3px; width:20px; height:20px; background:#fff; border-radius:50%; transition:transform .2s; }
        .toggle.active::after { transform:translateX(22px); }

        .form-group { margin-bottom:14px; }
        .form-group label { display:block; font-size:12px; color:var(--text-dim); margin-bottom:6px; font-weight:500; }
        .form-group input, .form-group select { width:100%; padding:10px 12px; background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius); color:var(--text); font-size:13px; outline:none; }
        .form-group input:focus, .form-group select:focus { border-color:var(--accent); }
        .form-group small { display:block; margin-top:4px; font-size:11px; color:var(--text-dim); }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }

        .info-banner { display:flex; align-items:flex-start; gap:10px; border-radius:var(--radius); padding:14px 16px; margin-bottom:16px; }
        .info-banner.warn { background:rgba(251,191,36,0.08); border:1px solid rgba(251,191,36,0.2); }
        .info-banner.warn p { color:#fbbf24; }
        .info-banner.info { background:rgba(99,102,241,0.08); border:1px solid rgba(99,102,241,0.2); }
        .info-banner.info p { color:#a5b4fc; }
        .info-banner svg { flex-shrink:0; margin-top:1px; }
        .info-banner p { font-size:12px; line-height:1.5; }
        .info-banner code { background:rgba(255,255,255,0.08); padding:1px 6px; border-radius:3px; font-family:monospace; font-size:11px; }

        .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; margin-bottom:16px; }
        .stat-card { background:var(--bg-input); border-radius:8px; padding:12px; text-align:center; }
        .stat-card .val { font-size:18px; font-weight:700; }
        .stat-card .lbl { font-size:10px; color:var(--text-dim); text-transform:uppercase; letter-spacing:.3px; margin-top:2px; }

        .target-header { display:flex; align-items:center; gap:16px; padding-bottom:16px; border-bottom:1px solid var(--border); margin-bottom:16px; }
        .target-avatar { width:56px; height:56px; border-radius:50%; background:#27272a; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:22px; overflow:hidden; flex-shrink:0; }
        .target-avatar img { width:100%; height:100%; object-fit:cover; }
        .target-links { display:flex; gap:10px; margin-top:4px; }
        .target-links a { font-size:12px; display:flex; align-items:center; gap:4px; }
        .wallet-mono { display:inline-flex; align-items:center; gap:6px; background:var(--bg-input); padding:4px 10px; border-radius:5px; font-family:monospace; font-size:11px; color:var(--text-dim); }
        .wallet-mono button { background:none; border:none; color:var(--text-dim); cursor:pointer; padding:2px; }

        .positions-list { max-height:280px; overflow-y:auto; }
        .position-item { display:flex; align-items:center; gap:10px; padding:10px 0; border-bottom:1px solid var(--border); }
        .position-item:last-child { border-bottom:none; }
        .position-icon { width:32px; height:32px; border-radius:6px; background:#27272a; overflow:hidden; flex-shrink:0; }
        .position-icon img { width:100%; height:100%; object-fit:cover; }
        .position-info { flex:1; min-width:0; }
        .position-info .title { font-size:13px; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .position-info .outcome { font-size:11px; color:var(--text-dim); }
        .position-pnl { text-align:right; }
        .position-pnl .size { font-size:13px; font-weight:600; }
        .position-pnl .pnl { font-size:11px; }

        .log-panel { max-height:500px; overflow-y:auto; font-family:'SF Mono',SFMono-Regular,Consolas,'Liberation Mono',Menlo,monospace; font-size:12px; background:#0a0a0c; border-radius:8px; padding:12px; }
        .log-entry { padding:4px 0; border-bottom:1px solid rgba(255,255,255,0.03); display:flex; gap:10px; line-height:1.6; }
        .log-entry .log-time { color:var(--text-dim); white-space:nowrap; flex-shrink:0; }
        .log-entry .log-level { font-weight:600; width:56px; flex-shrink:0; text-transform:uppercase; }
        .log-entry .log-msg { color:var(--text-sec); flex:1; word-break:break-word; }
        .log-level.INFO { color:var(--accent); } .log-level.SUCCESS { color:var(--green); }
        .log-level.ERROR, .log-level.FAILED { color:var(--red); } .log-level.WARN { color:var(--yellow); }
        .log-level.COPY { color:#c084fc; } .log-level.SKIP { color:var(--text-dim); }

        .ct-table { width:100%; border-collapse:collapse; }
        .ct-table th { text-align:left; padding:8px 10px; font-size:11px; font-weight:500; color:var(--text-dim); text-transform:uppercase; background:var(--bg-input); letter-spacing:.3px; }
        .ct-table th:first-child { border-radius:6px 0 0 6px; } .ct-table th:last-child { border-radius:0 6px 6px 0; }
        .ct-table td { padding:8px 10px; font-size:12px; border-bottom:1px solid var(--border); }

        .trades-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
        .trades-header h2 { font-size:16px; font-weight:600; }
        .filter-buttons { display:flex; gap:4px; }
        .filter-btn { padding:6px 14px; background:var(--bg-input); border:none; border-radius:6px; color:var(--text-dim); font-size:12px; cursor:pointer; transition:all .15s; }
        .filter-btn:hover, .filter-btn.active { background:var(--accent); color:#fff; }
        .trades-table { width:100%; border-collapse:collapse; }
        .trades-table th { text-align:left; padding:10px 14px; background:var(--bg-input); font-size:11px; font-weight:500; color:var(--text-dim); text-transform:uppercase; letter-spacing:.3px; }
        .trades-table th:first-child { border-radius:8px 0 0 8px; } .trades-table th:last-child { border-radius:0 8px 8px 0; }
        .trades-table td { padding:12px 14px; border-bottom:1px solid var(--border); font-size:13px; }
        .trade-row { transition:background .1s; } .trade-row:hover { background:var(--bg-hover); }
        .trade-trader { display:flex; align-items:center; gap:8px; }
        .trade-trader-avatar { width:28px; height:28px; border-radius:50%; background:#27272a; display:flex; align-items:center; justify-content:center; font-size:11px; overflow:hidden; }
        .trade-trader-avatar img { width:100%; height:100%; object-fit:cover; }
        .trade-market { display:flex; align-items:center; gap:8px; }
        .trade-market-icon { width:28px; height:28px; border-radius:5px; background:#27272a; overflow:hidden; }
        .trade-market-icon img { width:100%; height:100%; object-fit:cover; }
        .trade-market-title { font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:280px; }
        .trade-market-outcome { font-size:11px; color:var(--text-dim); }
        .side-buy { color:var(--green); font-weight:600; } .side-sell { color:var(--red); font-weight:600; }

        .empty-state { text-align:center; padding:40px 20px; color:var(--text-dim); }
        .empty-state h3 { font-size:15px; color:var(--text-sec); margin-bottom:6px; }
        .spinner { width:32px; height:32px; border:3px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .8s linear infinite; margin:0 auto; }
        @keyframes spin { to { transform:rotate(360deg); } }

        .toast { position:fixed; bottom:20px; right:20px; padding:12px 20px; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; color:var(--text); font-size:13px; box-shadow:0 8px 24px rgba(0,0,0,.4); transform:translateY(80px); opacity:0; transition:all .25s; z-index:999; }
        .toast.show { transform:translateY(0); opacity:1; }
        .toast.error { border-color:var(--red); } .toast.success { border-color:var(--green); }

        ::-webkit-scrollbar { width:6px; } ::-webkit-scrollbar-track { background:transparent; } ::-webkit-scrollbar-thumb { background:#27272a; border-radius:3px; }

        @media (max-width:900px) {
            .panels { flex-direction:column; }
            .panel-left { width:100%; min-width:100%; border-right:none; border-bottom:1px solid var(--border); max-height:250px; }
            .grid-2 { grid-template-columns:1fr; }
            .topbar-nav { display:none; }
        }
    </style>
</head>
<body>
<div class="app">
    <div class="topbar">
        <div class="topbar-left">
            <div class="topbar-logo">Polymarket Copy Trader</div>
            <div class="topbar-nav">
                <button class="active" data-page="copy" onclick="switchPage('copy')">Dashboard</button>
                <button data-page="trades" onclick="switchPage('trades')">Trade Feed</button>
                <button data-page="log" onclick="switchPage('log')">Engine Log</button>
            </div>
        </div>
        <div class="topbar-right">
            <div class="engine-badge off" id="engine-badge" onclick="toggleEngine()">
                <div class="live-dot" id="engine-dot" style="background:var(--red);"></div>
                <span id="engine-label">Engine Off</span>
            </div>
            <div class="live-badge" id="stream-status">
                <div class="live-dot" id="stream-dot"></div>
                <span id="stream-label">Connecting...</span>
            </div>
            <div class="balance-chip" id="header-balance" style="display:none;">
                <span class="label">USDC</span>
                <span id="header-balance-amount">$0.00</span>
            </div>
        </div>
    </div>

    <div class="panels">
        <div class="panel-left">
            <div class="section-label">Target Wallets</div>
            <div class="add-form">
                <input type="text" id="wallet-input" placeholder="Paste wallet (0x...)">
                <button class="btn btn-sm" onclick="addTrader()">Track</button>
            </div>
            <div id="trader-list"><div style="padding:32px;text-align:center;"><div class="spinner"></div></div></div>
        </div>

        <div class="panel-center">
            <!-- Page: Dashboard -->
            <div class="page active" id="page-copy">
                <!-- No wallet banner -->
                <div class="info-banner warn" id="no-wallet-banner" style="display:none;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                    <p>No wallet configured. Run <code>python setup_config.py</code> in your terminal to set up your private key and wallet address, then restart <code>python app.py</code>.</p>
                </div>

                <div class="grid-2">
                    <!-- Your Wallet -->
                    <div class="card">
                        <h3>Your Wallet</h3>
                        <div id="wallet-status">
                            <div style="padding:20px;text-align:center;"><div class="spinner"></div></div>
                        </div>
                    </div>
                    <!-- Copy Trading Engine -->
                    <div class="card">
                        <h3>Copy Trading Engine</h3>
                        <div class="toggle-row" style="margin-bottom:10px;">
                            <div class="info"><h4>Master Switch</h4><p>Enable to start copying trades</p></div>
                            <div class="toggle" id="master-toggle" onclick="toggleMaster()"></div>
                        </div>
                        <div class="status-row"><span class="label">Engine</span><span class="value" id="engine-status-text"><span class="dot off"></span>Stopped</span></div>
                        <div class="status-row"><span class="label">Traders Copied</span><span class="value" id="copy-trader-count">0</span></div>
                        <div class="status-row"><span class="label">Trades Copied</span><span class="value" style="color:var(--green);" id="engine-copied">0</span></div>
                        <div class="status-row"><span class="label">Failed</span><span class="value" style="color:var(--red);" id="engine-failed">0</span></div>
                        <div class="status-row"><span class="label">Copy %</span><span class="value" id="copy-pct-display">10%</span></div>
                        <div class="status-row"><span class="label">Max Trade</span><span class="value" id="copy-max-display">$100</span></div>
                        <div class="status-row"><span class="label">Last Check</span><span class="value" style="font-size:11px;color:var(--text-dim);" id="last-check">--</span></div>
                    </div>
                </div>

                <!-- Target Detail -->
                <div class="card" id="target-detail" style="display:none;">
                    <h3>Target Wallet Details</h3>
                    <div class="target-header">
                        <div class="target-avatar" id="target-avatar">?</div>
                        <div>
                            <div style="font-size:18px;font-weight:600;display:flex;align-items:center;gap:6px;">
                                <span id="target-name">--</span>
                                <span class="badge-verified" id="target-verified" style="display:none;">&#10003;</span>
                            </div>
                            <div style="font-size:12px;color:var(--text-dim);" id="target-pseudonym"></div>
                            <div class="target-links">
                                <a href="#" id="target-x-link" style="display:none;" target="_blank"><span id="target-x-user"></span></a>
                                <a href="#" id="target-poly-link" target="_blank">Polymarket</a>
                                <a href="#" id="target-scan-link" target="_blank">Polygonscan</a>
                            </div>
                            <div style="margin-top:6px;"><span class="wallet-mono"><span id="target-wallet">0x...</span><button onclick="copyAddr()">Copy</button></span></div>
                        </div>
                    </div>
                    <div id="target-bio" style="font-size:13px;color:var(--text-sec);margin-bottom:14px;"></div>
                    <div class="stats-grid" id="target-stats">
                        <div class="stat-card"><div class="val" id="ts-trades">0</div><div class="lbl">Trades</div></div>
                        <div class="stat-card"><div class="val" id="ts-volume">$0</div><div class="lbl">Volume</div></div>
                        <div class="stat-card"><div class="val" id="ts-buys">0</div><div class="lbl">Buys</div></div>
                        <div class="stat-card"><div class="val" id="ts-sells">0</div><div class="lbl">Sells</div></div>
                        <div class="stat-card"><div class="val" id="ts-avgbuy">0c</div><div class="lbl">Avg Buy</div></div>
                        <div class="stat-card"><div class="val" id="ts-avgsell">0c</div><div class="lbl">Avg Sell</div></div>
                    </div>
                    <div class="toggle-row"><div class="info"><h4>Copy This Trader</h4><p>Mirror their buys and sells</p></div><div class="toggle" id="trader-copy-toggle" onclick="toggleTraderCopy()"></div></div>
                    <h3 style="font-size:13px;font-weight:500;color:var(--text-dim);text-transform:uppercase;letter-spacing:.3px;margin:16px 0 10px;">Active Positions</h3>
                    <div class="positions-list" id="target-positions"><div class="empty-state"><p>No position data</p></div></div>
                    <h3 style="font-size:13px;font-weight:500;color:var(--text-dim);text-transform:uppercase;letter-spacing:.3px;margin:16px 0 10px;">Most Traded Markets</h3>
                    <div id="target-markets"><div class="empty-state"><p>No data yet</p></div></div>
                </div>

                <!-- Recent Engine Log Preview -->
                <div class="card" style="margin-top:16px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                        <h3 style="margin-bottom:0;">Recent Engine Activity</h3>
                        <button class="btn btn-sm btn-outline" onclick="switchPage('log')">View Full Log</button>
                    </div>
                    <div class="log-panel" id="recent-log" style="max-height:200px;">
                        <div class="empty-state" style="padding:20px;"><p>No log entries yet. Engine activity appears here in real-time.</p></div>
                    </div>
                </div>

                <!-- Copy Trades History -->
                <div class="card" style="margin-top:16px;">
                    <h3>Copy Trade History</h3>
                    <div id="copy-trades-content"><div class="empty-state"><p>No copy trades yet</p></div></div>
                </div>
            </div>

            <!-- Page: Trade Feed -->
            <div class="page" id="page-trades">
                <div class="trades-header">
                    <h2>Trade Feed</h2>
                    <div class="filter-buttons">
                        <button class="filter-btn active" data-filter="all" onclick="filterTrades('all')">All</button>
                        <button class="filter-btn" data-filter="BUY" onclick="filterTrades('BUY')">Buys</button>
                        <button class="filter-btn" data-filter="SELL" onclick="filterTrades('SELL')">Sells</button>
                    </div>
                </div>
                <table class="trades-table">
                    <thead><tr><th>Trader</th><th>Market</th><th>Side</th><th>Amount</th><th>Price</th><th>Time</th></tr></thead>
                    <tbody id="trades-body"><tr><td colspan="6"><div style="padding:32px;text-align:center;"><div class="spinner"></div></div></td></tr></tbody>
                </table>
            </div>

            <!-- Page: Engine Log -->
            <div class="page" id="page-log">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h2 style="font-size:16px;font-weight:600;">Copy Trading Engine Log</h2>
                    <button class="btn btn-sm btn-outline" onclick="fetchLog()">Refresh</button>
                </div>
                <div class="log-panel" id="log-panel">
                    <div class="empty-state"><p>No log entries yet. Start the engine to see activity.</p></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    let allTrades=[], currentFilter='all', selectedTraderId=null, currentDetail=null, config={}, logEntries=[];

    function formatTime(ts) { if(!ts)return '--'; const d=new Date(ts*1000),now=new Date(),diff=now-d; if(diff<60000)return 'Just now'; if(diff<3600000)return Math.floor(diff/60000)+'m ago'; if(diff<86400000)return Math.floor(diff/3600000)+'h ago'; return d.toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}); }
    function formatUSD(n) { if(!n)return '$0'; n=parseFloat(n); if(n>=1e6)return '$'+(n/1e6).toFixed(2)+'M'; if(n>=1e3)return '$'+(n/1e3).toFixed(1)+'K'; return '$'+n.toFixed(2); }
    function truncAddr(a) { return a?a.slice(0,6)+'...'+a.slice(-4):''; }
    function showToast(msg,type='info') { const t=document.getElementById('toast'); t.textContent=msg; t.className='toast '+type+' show'; setTimeout(()=>t.classList.remove('show'),3500); }

    function switchPage(p) { document.querySelectorAll('.topbar-nav button').forEach(b=>b.classList.toggle('active',b.dataset.page===p)); document.querySelectorAll('.page').forEach(el=>el.classList.toggle('active',el.id==='page-'+p)); if(p==='log')fetchLog(); }

    // ---- Traders ----
    async function fetchTraders() {
        try { const r=await fetch('/api/traders'); const traders=await r.json(); renderTraders(traders); document.getElementById('copy-trader-count').textContent=traders.filter(t=>t.copy_trading_enabled).length; } catch(e){}
    }
    function renderTraders(traders) {
        const el=document.getElementById('trader-list');
        if(!traders.length){el.innerHTML='<div class="empty-state" style="padding:24px;"><h3>No wallets tracked</h3><p>Add a wallet address above</p></div>';return;}
        el.innerHTML=traders.map(t=>{
            const name=t.name||t.pseudonym||truncAddr(t.wallet_address), init=name.charAt(0).toUpperCase();
            const av=t.profile_image?`<img src="${t.profile_image}" alt="${name}" onerror="this.parentElement.innerHTML='${init}'">`  :init;
            const cb=t.copy_trading_enabled?'<span class="badge badge-copy">COPY</span>':'';
            return `<div class="trader-item ${selectedTraderId===t.id?'active':''}" onclick="selectTrader(${t.id})"><div class="trader-avatar">${av}</div><div class="trader-meta"><div class="name">${name} ${t.verified_badge?'<span class="badge-verified">&#10003;</span>':''} ${cb}</div><div class="addr">${truncAddr(t.wallet_address)}</div></div><button class="remove-btn" onclick="event.stopPropagation();deleteTrader(${t.id})" title="Remove">&times;</button></div>`;
        }).join('');
    }
    async function addTrader() { const v=document.getElementById('wallet-input').value.trim(); if(!v){showToast('Enter a wallet','error');return;} try{const r=await fetch('/api/traders',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({wallet_address:v})}); const res=await r.json(); if(r.ok){showToast('Wallet added!','success');document.getElementById('wallet-input').value='';fetchTraders();fetchStats();}else showToast(res.error,'error');}catch(e){showToast('Error','error');} }
    async function deleteTrader(id) { if(!confirm('Remove this trader?'))return; try{await fetch('/api/traders/'+id,{method:'DELETE'}); if(selectedTraderId===id){selectedTraderId=null;document.getElementById('target-detail').style.display='none';} showToast('Removed','success'); fetchTraders();fetchTrades();fetchStats();}catch(e){} }
    document.getElementById('wallet-input').addEventListener('keypress',e=>{if(e.key==='Enter')addTrader();});

    function selectTrader(id) { if(selectedTraderId===id){selectedTraderId=null;document.getElementById('target-detail').style.display='none';}else{selectedTraderId=id;fetchTraderDetails(id);} fetchTraders();fetchTrades(); }
    async function fetchTraderDetails(id) { try{const r=await fetch('/api/traders/'+id+'/details'); currentDetail=await r.json(); renderDetail(currentDetail); fetchPositions(currentDetail.wallet_address);}catch(e){} }
    function renderDetail(t) {
        document.getElementById('target-detail').style.display='block';
        const name=t.name||t.pseudonym||truncAddr(t.wallet_address),init=name.charAt(0).toUpperCase();
        document.getElementById('target-avatar').innerHTML=t.profile_image?`<img src="${t.profile_image}" onerror="this.parentElement.innerHTML='${init}'">`  :init;
        document.getElementById('target-name').textContent=name;
        document.getElementById('target-verified').style.display=t.verified_badge?'inline':'none';
        document.getElementById('target-pseudonym').textContent=(t.pseudonym&&t.pseudonym!==t.name)?'@'+t.pseudonym:'';
        document.getElementById('target-bio').textContent=t.bio||'';
        const xEl=document.getElementById('target-x-link'); if(t.x_username){xEl.href='https://x.com/'+t.x_username;document.getElementById('target-x-user').textContent='@'+t.x_username;xEl.style.display='flex';}else xEl.style.display='none';
        document.getElementById('target-poly-link').href='https://polymarket.com/profile/'+t.wallet_address;
        document.getElementById('target-scan-link').href='https://polygonscan.com/address/'+t.wallet_address;
        document.getElementById('target-wallet').textContent=t.wallet_address;
        document.getElementById('trader-copy-toggle').classList.toggle('active',!!t.copy_trading_enabled);
        if(t.stats){
            document.getElementById('ts-trades').textContent=(t.stats.total_trades||0).toLocaleString();
            document.getElementById('ts-volume').textContent=formatUSD(t.stats.volume_traded);
            document.getElementById('ts-buys').textContent=(t.stats.buy_count||0).toLocaleString();
            document.getElementById('ts-sells').textContent=(t.stats.sell_count||0).toLocaleString();
            document.getElementById('ts-avgbuy').textContent=(t.stats.avg_buy_price||0)+'c';
            document.getElementById('ts-avgsell').textContent=(t.stats.avg_sell_price||0)+'c';
        }
        const mkts=document.getElementById('target-markets');
        if(t.recent_markets&&t.recent_markets.length) mkts.innerHTML=t.recent_markets.map(m=>`<div class="position-item"><div class="position-icon">${m.icon?`<img src="${m.icon}" onerror="this.style.display='none'">`:''}</div><div class="position-info"><div class="title">${m.title||'Unknown'}</div><div class="outcome">${m.outcome||''}</div></div><div class="position-pnl"><div class="size">${formatUSD(m.volume)}</div><div class="pnl" style="color:var(--text-dim);">${m.trade_count} trades</div></div></div>`).join('');
        else mkts.innerHTML='<div class="empty-state"><p>No data yet</p></div>';
    }
    async function fetchPositions(w) { try{const r=await fetch('/api/positions/'+w); const pos=await r.json(); const el=document.getElementById('target-positions'); if(Array.isArray(pos)&&pos.length) el.innerHTML=pos.map(p=>{const c=(p.cashPnl||0)>=0?'var(--green)':'var(--red)',s=(p.cashPnl||0)>=0?'+':''; return `<div class="position-item"><div class="position-icon">${p.icon?`<img src="${p.icon}" onerror="this.style.display='none'">`:''}</div><div class="position-info"><div class="title">${p.title||'...'}</div><div class="outcome">${p.outcome||''} &middot; ${p.size?parseFloat(p.size).toFixed(1)+' shares':''}</div></div><div class="position-pnl"><div class="size">${formatUSD(p.currentValue)}</div><div class="pnl" style="color:${c};">${s}${formatUSD(p.cashPnl)} (${s}${((p.percentPnl||0)*100).toFixed(1)}%)</div></div></div>`;}).join(''); else el.innerHTML='<div class="empty-state"><p>No open positions</p></div>';} catch(e){document.getElementById('target-positions').innerHTML='<div class="empty-state"><p>Could not fetch</p></div>';} }
    function copyAddr() { if(currentDetail)navigator.clipboard.writeText(currentDetail.wallet_address).then(()=>showToast('Copied!','success')); }

    // ---- Copy Trading Toggles ----
    async function toggleTraderCopy() { if(!currentDetail)return; const n=!currentDetail.copy_trading_enabled; try{const r=await fetch('/api/traders/'+currentDetail.id+'/copy',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({enabled:n})}); if(r.ok){currentDetail.copy_trading_enabled=n;document.getElementById('trader-copy-toggle').classList.toggle('active',n);showToast(n?'Copy enabled':'Copy disabled',n?'success':'info');fetchTraders();}}catch(e){} }
    async function toggleMaster() { const n=!config.copy_trading_enabled; try{const r=await fetch('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({copy_trading_enabled:n})}); if(r.ok){config.copy_trading_enabled=n;document.getElementById('master-toggle').classList.toggle('active',n);updateStatus();showToast(n?'Copy trading enabled!':'Disabled',n?'success':'info');}}catch(e){} }

    function updateStatus() {
        const el=document.getElementById('engine-status-text');
        if(config.engine_running&&config.copy_trading_enabled&&config.has_credentials) el.innerHTML='<span class="dot on"></span>Running';
        else if(config.copy_trading_enabled&&!config.has_credentials) el.innerHTML='<span class="dot warn"></span>No Wallet';
        else if(config.engine_running&&!config.copy_trading_enabled) el.innerHTML='<span class="dot warn"></span>Idle (disabled)';
        else el.innerHTML='<span class="dot off"></span>Stopped';
    }

    // ---- Engine Control ----
    async function toggleEngine() {
        const running=config.engine_running;
        try{const r=await fetch('/api/engine/'+(running?'stop':'start'),{method:'POST'}); if(r.ok){config.engine_running=!running;updateEngineUI();showToast(running?'Engine stopped':'Engine started',running?'info':'success');}}catch(e){showToast('Error','error');}
    }
    function updateEngineUI() {
        const badge=document.getElementById('engine-badge'), dot=document.getElementById('engine-dot'), label=document.getElementById('engine-label');
        if(config.engine_running){badge.classList.remove('off');badge.classList.add('on');dot.style.background='var(--green)';label.textContent='Engine Running';}
        else{badge.classList.remove('on');badge.classList.add('off');dot.style.background='var(--red)';label.textContent='Engine Off';}
    }

    // ---- Config (read-only from Python config.json) ----
    async function loadConfig() {
        try{const r=await fetch('/api/config'); config=await r.json();
        document.getElementById('copy-pct-display').textContent=(config.copy_percentage||10)+'%';
        document.getElementById('copy-max-display').textContent='$'+(config.max_trade_size||100);
        document.getElementById('master-toggle').classList.toggle('active',!!config.copy_trading_enabled);
        document.getElementById('engine-copied').textContent=(config.trades_copied||0).toLocaleString();
        document.getElementById('engine-failed').textContent=(config.trades_failed||0).toLocaleString();
        document.getElementById('last-check').textContent=config.last_check?new Date(config.last_check).toLocaleTimeString():'--';
        updateStatus(); updateEngineUI(); renderWallet();
        }catch(e){}
    }
    function renderWallet() {
        const el=document.getElementById('wallet-status');
        const banner=document.getElementById('no-wallet-banner');
        if(config.has_credentials){
            banner.style.display='none';
            const bal=config.usdc_balance!==null&&config.usdc_balance!==undefined?'$'+config.usdc_balance.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2}):'Loading...';
            // Also update header balance
            if(config.usdc_balance!==null&&config.usdc_balance!==undefined){
                document.getElementById('header-balance-amount').textContent='$'+config.usdc_balance.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
                document.getElementById('header-balance').style.display='flex';
            }
            el.innerHTML=`
                <div class="status-row"><span class="label">Status</span><span class="value"><span class="dot on"></span>Connected</span></div>
                <div class="status-row"><span class="label">Wallet</span><span class="value" style="font-family:monospace;font-size:12px;">${truncAddr(config.funder_address)}</span></div>
                <div class="status-row"><span class="label">USDC Balance</span><span class="value" style="color:var(--green);">${bal}</span></div>
                <div class="status-row"><span class="label">CLOB Client</span><span class="value">${config.clob_available?'<span class="dot on"></span>Available':'<span class="dot off"></span>Not installed'}</span></div>
                <div class="status-row"><span class="label">Signature</span><span class="value" style="color:var(--text-dim);">Type ${config.signature_type||1}</span></div>
            `;
        } else {
            banner.style.display='flex';
            document.getElementById('header-balance').style.display='none';
            el.innerHTML=`
                <div class="status-row"><span class="label">Status</span><span class="value"><span class="dot off"></span>Not Connected</span></div>
                <div style="margin-top:12px;">
                    <div class="info-banner info" style="margin-bottom:0;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                        <p>Run <code>python setup_config.py</code> in your terminal to configure your wallet and private key. Then restart the server.</p>
                    </div>
                </div>
            `;
        }
    }

    // ---- Stats ----
    async function fetchStats() { try{await fetch('/api/stats');}catch(e){} }

    // ---- Trades ----
    async function fetchTrades() { try{let url='/api/trades?limit=200'; if(selectedTraderId)url+='&trader_id='+selectedTraderId; const r=await fetch(url); allTrades=await r.json(); renderTrades();}catch(e){} }
    function filterTrades(f) { currentFilter=f; document.querySelectorAll('.filter-btn').forEach(b=>b.classList.toggle('active',b.dataset.filter===f)); renderTrades(); }
    function renderTrades() {
        const tbody=document.getElementById('trades-body'); let filtered=allTrades;
        if(currentFilter!=='all')filtered=allTrades.filter(t=>(t.side||'').toUpperCase()===currentFilter.toUpperCase());
        if(!filtered.length){tbody.innerHTML='<tr><td colspan="6"><div class="empty-state"><h3>No trades yet</h3><p>Trades appear once fetcher detects activity</p></div></td></tr>';return;}
        tbody.innerHTML=filtered.map(t=>{
            const name=t.name||t.pseudonym||truncAddr(t.wallet_address),init=name.charAt(0).toUpperCase();
            const av=t.profile_image?`<img src="${t.profile_image}" onerror="this.parentElement.innerHTML='${init}'">`  :init;
            const mi=t.icon?`<img src="${t.icon}" onerror="this.style.display='none'">`  :'';
            return `<tr class="trade-row"><td><div class="trade-trader"><div class="trade-trader-avatar">${av}</div><span>${name}</span></div></td><td><div class="trade-market"><div class="trade-market-icon">${mi}</div><div><div class="trade-market-title">${t.title||'Unknown'}</div><div class="trade-market-outcome">${t.outcome||''}</div></div></div></td><td><span class="side-${(t.side||'').toLowerCase()}">${(t.side||'').toUpperCase()}</span></td><td style="font-weight:500;">${formatUSD(t.usdc_size)}</td><td style="color:var(--text-dim);">${t.price?(t.price*100).toFixed(1)+'c':'-'}</td><td style="color:var(--text-dim);font-size:12px;">${formatTime(t.timestamp)}</td></tr>`;
        }).join('');
    }

    // ---- Copy Trade History ----
    async function fetchCopyTrades() {
        try{const r=await fetch('/api/copy-trades'); const trades=await r.json();
        const el=document.getElementById('copy-trades-content');
        if(!trades.length){el.innerHTML='<div class="empty-state"><p>No copy trades yet</p></div>';return;}
        el.innerHTML=`<table class="ct-table"><thead><tr><th>Time</th><th>Trader</th><th>Market</th><th>Side</th><th>Original</th><th>Our Size</th><th>Status</th></tr></thead><tbody>${trades.map(t=>`<tr><td style="font-size:11px;color:var(--text-dim);white-space:nowrap;">${t.executed_at?new Date(t.executed_at).toLocaleString():'--'}</td><td style="font-size:12px;">${t.trader_name||'--'}</td><td style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.market_title||'--'}</td><td><span class="side-${(t.side||'').toLowerCase()}">${(t.side||'').toUpperCase()}</span></td><td>${formatUSD(t.original_size)}</td><td style="font-weight:600;">${formatUSD(t.our_size)}</td><td><span style="color:${t.status==='SUCCESS'?'var(--green)':'var(--red)'};">${t.status}</span></td></tr>`).join('')}</tbody></table>`;}catch(e){}
    }

    // ---- Engine Log ----
    async function fetchLog() {
        try{const r=await fetch('/api/copy-log?limit=200'); logEntries=await r.json(); renderLog(); renderRecentLog();}catch(e){}
    }
    function renderLog() {
        const el=document.getElementById('log-panel');
        if(!logEntries.length){el.innerHTML='<div class="empty-state"><p>No log entries yet. Start the engine to see activity.</p></div>';return;}
        el.innerHTML=logEntries.map(l=>{
            const t=l.timestamp?new Date(l.timestamp).toLocaleTimeString():'--';
            return `<div class="log-entry"><span class="log-time">${t}</span><span class="log-level ${l.level}">${l.level}</span><span class="log-msg">${l.message}${l.details?' <span style="color:var(--text-dim);">'+l.details+'</span>':''}</span></div>`;
        }).join('');
        el.scrollTop=0;
    }
    function renderRecentLog() {
        const el=document.getElementById('recent-log');
        const recent=logEntries.slice(0,10);
        if(!recent.length){el.innerHTML='<div class="empty-state" style="padding:20px;"><p>No log entries yet</p></div>';return;}
        el.innerHTML=recent.map(l=>{
            const t=l.timestamp?new Date(l.timestamp).toLocaleTimeString():'--';
            return `<div class="log-entry"><span class="log-time">${t}</span><span class="log-level ${l.level}">${l.level}</span><span class="log-msg">${l.message}</span></div>`;
        }).join('');
    }
    function appendLogEntries(newLogs) {
        logEntries=newLogs.concat(logEntries);
        if(document.getElementById('page-log').classList.contains('active'))renderLog();
        renderRecentLog();
    }

    // ---- SSE ----
    let eventSource=null, sseRetries=0;
    function connectSSE() {
        const dot=document.getElementById('stream-dot'),label=document.getElementById('stream-label');
        if(eventSource)eventSource.close();
        dot.style.background='var(--yellow)';label.textContent='Connecting...';
        eventSource=new EventSource('/api/stream');
        eventSource.onopen=()=>{dot.style.background='var(--green)';label.textContent='Live';sseRetries=0;};
        eventSource.onmessage=(ev)=>{
            try{const data=JSON.parse(ev.data);
            if(data.type==='new_trades'&&data.trades?.length){
                dot.style.background='var(--accent)';label.textContent='New trade!';
                setTimeout(()=>{dot.style.background='var(--green)';label.textContent='Live';},2000);
                fetchStats();fetchTraders();fetchTrades();
                const lt=data.trades[data.trades.length-1];
                showToast(`${lt.name||lt.pseudonym||(lt.wallet_address||'').slice(0,10)}: ${lt.side||'?'} ${lt.usdc_size?'$'+parseFloat(lt.usdc_size).toFixed(2):''} on ${(lt.title||'market').slice(0,40)}`,'success');
            }
            if(data.type==='copy_log'&&data.logs?.length){appendLogEntries(data.logs);}
            if(data.type==='copy_trades'&&data.trades?.length){fetchCopyTrades();}
            if(data.type==='heartbeat'){
                dot.style.background='var(--green)';label.textContent='Live';
                if(data.engine_running!==undefined){config.engine_running=data.engine_running;updateEngineUI();updateStatus();}
            }}catch(e){}
        };
        eventSource.onerror=()=>{dot.style.background='var(--red)';label.textContent='Reconnecting...';eventSource.close();sseRetries++;setTimeout(connectSSE,Math.min(1000*Math.pow(2,sseRetries),30000));};
    }

    // ---- Init ----
    fetchStats();fetchTraders();fetchTrades();loadConfig();fetchCopyTrades();fetchLog();
    connectSSE();
    // Refresh config (includes balance) every 30s
    setInterval(loadConfig,30000);
</script>
</body>
</html>
